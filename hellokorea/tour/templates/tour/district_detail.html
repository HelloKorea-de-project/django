{% extends 'base.html' %} {% block content %}
<h1>{{ district_name }}</h1>
<div class="district-container">
  <div class="content-container">
    <div class="map-container">
      <div id="map" style="width: 100%; height: 400px"></div>
      <span>주소</span>
    </div>
    <div class="list-container">
      <div class="theme-container">
        <div class="head-section">
          <h2>Attractions</h2>
          <select id="mainCategories" name="mainCategories">
            <option value="">All</option>
            {% for category in main_categories %}
            <option value="{{ category }}">{{ category }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="scroll-container">
          <div class="card-container" id="attractions-container">
            <!-- Cards will be appended here -->
          </div>
        </div>
      </div>
      <div class="theme-container">
        <div class="head-section">
          <h2>Performances/Festivals</h2>
          <div class="filter-container">
            <input type="date" id="startdate" name="startdate" />
            <input type="date" id="enddate" name="enddate" />
            <select id="genrenms" name="genrenms">
              <option value="">All</option>
              {% for genre in genres %}
              <option value="{{ genre }}">{{ genre }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="scroll-container">
          <div class="card-container" id="performances-container">
            <!-- Cards will be appended here -->
          </div>
        </div>
      </div>
      <div class="theme-container">
        <div class="head-section">
          <h2>Accommodations</h2>
          <select id="uptaenms" name="uptaenms">
            <option value="">All</option>
            {% for type in lodging_types %}
            <option value="{{ type }}">{{ type }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="scroll-container">
          <div class="card-container" id="lodgings-container">
            <!-- Cards will be appended here -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  body,
  html {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    display: flex;
    flex-direction: column;
    padding-top: 60px;
  }

  .district-container {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    /* height: 100vh; */
    margin-bottom: 50px;
  }

  .content-container {
    position: relative;
    width: 85%;
    height: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .list-container {
    /* width: 650px; */
    display: flex;
    flex: 3;
    /* height: 100%; */
    justify-content: center;
    align-items: center;
    flex-direction: column;
    gap: 30px;
    margin-left: 50px;
  }

  .scroll-container {
    width: 100%;
    max-width: 1000px; /* 특정 범위 설정 */
    overflow-x: auto;
  }
  .card-container {
    display: flex;
    width: max-content;
  }
  .card {
    background-color: #fff;
    width: 200px;
    margin: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    overflow: hidden;
    flex: 0 0 auto;
  }
  .card img {
    width: 100%;
    height: auto;
  }
  .card-content {
    padding: 16px;
  }
  .card-title {
    font-size: 18px;
    margin-bottom: 8px;
  }
  .card-details {
    font-size: 14px;
    color: #666;
  }
  .theme-container {
    width: 90%;
    height: 330px;
  }

  .head-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  select {
    height: fit-content;
  }

  .map-container {
    flex: 2;
  }
</style>

<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=941f361a0a2dea999051a0af3aaf3a85"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    var districtName = "{{ district_name }}";

    // Initialize Kakao Map
    var mapContainer = document.getElementById("map");
    var mapOptions = {
      center: new kakao.maps.LatLng(37.5665, 126.978),
      level: 3,
    };
    var map = new kakao.maps.Map(mapContainer, mapOptions);

    // Fetch initial data
    fetch(`/tour/district/${districtName}/all/`)
      .then((response) => response.json())
      .then((data) => {
        updateCards(data);
      });

    // Filter data based on user inputs
    document
      .getElementById("mainCategories")
      .addEventListener("change", function () {
        fetchFilteredData();
      });

    document
      .getElementById("startdate")
      .addEventListener("change", function () {
        fetchFilteredData();
      });

    document.getElementById("enddate").addEventListener("change", function () {
      fetchFilteredData();
    });

    document.getElementById("genrenms").addEventListener("change", function () {
      fetchFilteredData();
    });

    document.getElementById("uptaenms").addEventListener("change", function () {
      fetchFilteredData();
    });

    function fetchFilteredData() {
      var category = document.getElementById("mainCategories").value;
      var startDate = document.getElementById("startdate").value;
      var endDate = document.getElementById("enddate").value;
      var genre = document.getElementById("genrenms").value;
      var uptaenms = document.getElementById("uptaenms").value;

      var url = `/tour/district/${districtName}/filter/?category=${category}&start_date=${startDate}&end_date=${endDate}&genre=${genre}&uptaenms=${uptaenms}`;

      fetch(url)
        .then((response) => response.json())
        .then((data) => {
          updateCards(data);
        });
    }

    function updateCards(data) {
      // Update Attractions cards
      var attractionsContainer = document.getElementById(
        "attractions-container"
      );
      attractionsContainer.innerHTML = "";
      data.tour_infos.forEach((info) => {
        var card = createCard(
          info.firstImage,
          info.title,
          `${info.contentTypeID__subCategory1}(${info.contentTypeID__subCategory2})`,
          info.addr,
          info.la,
          info.lo
        );
        attractionsContainer.appendChild(card);
      });

      // Update Performances cards
      var performancesContainer = document.getElementById(
        "performances-container"
      );
      performancesContainer.innerHTML = "";
      data.performances.forEach((info) => {
        var card = createCard(
          info.poster,
          info.prfnm,
          `${info.genrenm}, ${info.prfpdfrom} - ${info.prfpdto}, ${info.pcseguidance}`,
          info.mt10id__adres,
          info.mt10id__la,
          info.mt10id__lo
        );
        performancesContainer.appendChild(card);
      });

      // Update Lodgings cards
      var lodgingsContainer = document.getElementById("lodgings-container");
      lodgingsContainer.innerHTML = "";
      data.lodgings.forEach((info) => {
        var card = createCard(
          "https://via.placeholder.com/200x150",
          info.bplcnm,
          info.uptaenm,
          info.rdnwhladdr,
          info.la,
          info.lo
        );
        lodgingsContainer.appendChild(card);
      });
    }

    function createCard(imageSrc, title, details, address, lat, lng) {
      var card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <img src="${imageSrc}" alt="이미지" />
        <div class="card-content">
          <div class="card-title">${title}</div>
          <div class="card-details">${details}</div>
        </div>
      `;
      card.addEventListener("mouseover", function () {
        console.log(lat, lng);
        var markerPosition = new kakao.maps.LatLng(lat, lng);
        var marker = new kakao.maps.Marker({
          position: markerPosition,
        });
        marker.setMap(map);
        map.setCenter(markerPosition);

        // Update the address span with the current card's address
        var addressSpan = document.querySelector(".map-container span");
        addressSpan.textContent = address;
      });
      return card;
    }
  });
</script>

{% endblock %}
